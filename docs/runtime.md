# Runtime Environment

This document describes the runtime environment for the training and inference processes, focusing on the Docker container and its interaction with AWS services.

## Docker Container

The application runs inside a Docker container based on a `micromamba` image.

-   **Base Image**: A minimal image with `micromamba` installed.
-   **Dependencies**: All necessary Python packages are installed via the `environment.yml` file.
-   **Entrypoint**: The container has an entrypoint script that orchestrates the runtime behavior based on the `MODE` environment variable (`train`, `test`, etc.).

### Entrypoint Logic (`entrypoint.sh`)

1.  **Activate Environment**: Activates the `micromamba` environment.
2.  **Sync Data from S3**: Pulls the training/validation data from the specified S3 bucket into the container's local `/app/data_box/inputs` directory.
3.  **Execute Main Script**: Runs the main Python script (`src/main.py`) with the appropriate arguments.
4.  **Sync Artifacts to S3**: After the script completes, it syncs the contents of the `/app/data_box/outputs` directory (logs, model adapters, checkpoints) to the specified S3 bucket.

## AWS Integration

-   **EC2 Instance**: The training job runs on a GPU-enabled EC2 instance (e.g., `g4dn.xlarge`) managed by an Auto Scaling Group (ASG).
-   **S3 Buckets**:
    -   **Input Bucket**: Stores the raw training and validation datasets.
    -   **Output Bucket**: Stores all artifacts generated by the training process, including model weights, logs, and evaluation results.
-   **IAM Roles**: An IAM role with permissions for S3, ECR, and SSM is attached to the EC2 instance.
-   **SSM Run Command**: Used to remotely execute commands on the EC2 instance without needing to SSH into it.

## Environment Variables

The following environment variables must be injected into the container at runtime:

-   `WANDB_API_KEY`: For logging metrics to Weights & Biases.
-   `S3_INPUT_BUCKET`: The name of the S3 bucket containing the input data.
-   `S3_OUTPUT_BUCKET`: The name of the S3 bucket for storing output artifacts.
-   `MODE`: The operational mode (`train`, `test`).
-   `AWS_REGION`: The AWS region where the resources are located.
